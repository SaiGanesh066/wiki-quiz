<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wiki Quiz Generator</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; }
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
    h1 { margin: 0 0 16px; }
    .tabs { display:flex; gap:10px; margin-bottom: 18px; }
    .tabbtn {
      padding: 10px 14px; border: 0; cursor:pointer; border-radius:10px;
      background:#e9e9e9;
    }
    .tabbtn.active { background:#111; color:#fff; }
    .card {
      background:#fff; border-radius:14px; padding:16px; box-shadow:0 4px 18px rgba(0,0,0,.06);
      margin-bottom:16px;
    }
    .row { display:flex; gap:10px; }
    input {
      flex:1; padding: 12px 12px; border:1px solid #ddd; border-radius:10px; outline:none;
    }
    button.primary {
      padding: 12px 14px; border:0; border-radius:10px; cursor:pointer; background:#1a73e8; color:#fff;
    }
    button.primary:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:#666; }
    .tags { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .tag { background:#f2f2f2; padding:6px 10px; border-radius:999px; font-size:13px; }
    .qcard { border:1px solid #eee; border-radius:12px; padding:12px; margin:10px 0; }
    ul { margin: 8px 0 0 18px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom:1px solid #eee; text-align:left; }
    td.url { max-width:420px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    button.small { padding:8px 10px; border:0; border-radius:10px; cursor:pointer; background:#111; color:#fff; }
    /* modal */
    .overlay {
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:none; align-items:center; justify-content:center; padding:20px;
    }
    .modal {
      width:min(920px, 95vw); max-height:90vh; overflow:auto;
      background:#fff; border-radius:14px; padding:16px; position:relative;
    }
    .close {
      position:absolute; top:12px; right:12px;
      width:36px; height:36px; border-radius:12px;
      border:0; cursor:pointer; background:#eee;
      font-weight:bold;
    }
    .error { color:#b00020; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wiki Quiz Generator</h1>

    <div class="tabs">
      <button id="tabGenerate" class="tabbtn active">Generate Quiz</button>
      <button id="tabHistory" class="tabbtn">Past Quizzes</button>
    </div>

    <!-- TAB: Generate -->
    <div id="generateView">
      <div class="card">
        <div class="row">
          <input id="wikiUrl" placeholder="Enter Wikipedia URL (ex: https://en.wikipedia.org/wiki/Alan_Turing)" />
          <button id="btnGenerate" class="primary">Generate Quiz</button>
        </div>
        <p class="muted" style="margin:10px 0 0;">
          Tip: Backend must be running at <b>http://127.0.0.1:8000</b>
        </p>
        <p id="genStatus" class="muted" style="margin:8px 0 0;"></p>
        <p id="genError" class="error" style="margin:8px 0 0;"></p>
      </div>

      <div id="quizOutput"></div>
    </div>

    <!-- TAB: History -->
    <div id="historyView" style="display:none;">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 style="margin:0;">History</h2>
          <button id="btnRefresh" class="small">Refresh</button>
        </div>
        <p id="histError" class="error"></p>
        <div style="overflow:auto;">
          <table id="histTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>URL</th>
                <th>Created</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal -->
  <div id="overlay" class="overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <button class="close" id="btnClose">X</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const API = "http://127.0.0.1:8000";

    // elements
    const tabGenerate = document.getElementById("tabGenerate");
    const tabHistory = document.getElementById("tabHistory");
    const generateView = document.getElementById("generateView");
    const historyView = document.getElementById("historyView");

    const wikiUrl = document.getElementById("wikiUrl");
    const btnGenerate = document.getElementById("btnGenerate");
    const genStatus = document.getElementById("genStatus");
    const genError = document.getElementById("genError");
    const quizOutput = document.getElementById("quizOutput");

    const btnRefresh = document.getElementById("btnRefresh");
    const histTableBody = document.querySelector("#histTable tbody");
    const histError = document.getElementById("histError");

    const overlay = document.getElementById("overlay");
    const btnClose = document.getElementById("btnClose");
    const modalContent = document.getElementById("modalContent");

    function setTab(which) {
      if (which === "generate") {
        tabGenerate.classList.add("active");
        tabHistory.classList.remove("active");
        generateView.style.display = "";
        historyView.style.display = "none";
      } else {
        tabHistory.classList.add("active");
        tabGenerate.classList.remove("active");
        historyView.style.display = "";
        generateView.style.display = "none";
        loadHistory();
      }
    }

    tabGenerate.onclick = () => setTab("generate");
    tabHistory.onclick = () => setTab("history");

    overlay.onclick = () => overlay.style.display = "none";
    btnClose.onclick = () => overlay.style.display = "none";

    function escapeHtml(str) {
      return (str || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function renderQuiz(data, targetEl) {
      const sections = (data.sections || []).map(s => `<span class="tag">${escapeHtml(s)}</span>`).join("");
      const related = (data.related_topics || []).map(s => `<span class="tag">${escapeHtml(s)}</span>`).join("");

      const ent = data.key_entities || {people:[], organizations:[], locations:[]};
      const entHtml = `
        <p><b>People:</b> ${escapeHtml(ent.people?.join(", ") || "-")}</p>
        <p><b>Organizations:</b> ${escapeHtml(ent.organizations?.join(", ") || "-")}</p>
        <p><b>Locations:</b> ${escapeHtml(ent.locations?.join(", ") || "-")}</p>
      `;

      const qHtml = (data.quiz || []).map((q, idx) => `
        <div class="qcard">
          <p><b>Q${idx+1}:</b> ${escapeHtml(q.question)}</p>
          <ul>
            ${(q.options || []).map(op => `<li>${escapeHtml(op)}</li>`).join("")}
          </ul>
          <p><b>Answer:</b> ${escapeHtml(q.answer)}</p>
          <p><b>Difficulty:</b> ${escapeHtml(q.difficulty)}</p>
          <p><b>Explanation:</b> ${escapeHtml(q.explanation)}</p>
        </div>
      `).join("");

      targetEl.innerHTML = `
        <div class="card">
          <h2 style="margin-top:0;">${escapeHtml(data.title)}</h2>
          <p><b>URL:</b> ${escapeHtml(data.url)}</p>
          <p><b>Summary:</b> ${escapeHtml(data.summary)}</p>

          <h3>Sections</h3>
          <div class="tags">${sections || "<span class='muted'>No sections found</span>"}</div>

          <h3>Key Entities</h3>
          <div>${entHtml}</div>

          <h3>Quiz</h3>
          ${qHtml || "<p class='muted'>No questions generated.</p>"}

          <h3>Related Topics</h3>
          <div class="tags">${related || "<span class='muted'>None</span>"}</div>
        </div>
      `;
    }

    async function generateQuiz() {
      genError.textContent = "";
      quizOutput.innerHTML = "";
      const url = wikiUrl.value.trim();
      if (!url) return;

      btnGenerate.disabled = true;
      genStatus.textContent = "Generating... Please wait";
      try {
        const res = await fetch(`${API}/generate`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({url})
        });
        const data = await res.json();

        if (!res.ok) {
          genError.textContent = data.detail || "Error generating quiz";
          genStatus.textContent = "";
        } else {
          genStatus.textContent = "Done âœ…";
          renderQuiz(data, quizOutput);
        }
      } catch (e) {
        genError.textContent = "Backend not reachable. Run uvicorn main:app --reload";
        genStatus.textContent = "";
      } finally {
        btnGenerate.disabled = false;
      }
    }

    btnGenerate.onclick = generateQuiz;

    async function loadHistory() {
      histError.textContent = "";
      histTableBody.innerHTML = "";
      try {
        const res = await fetch(`${API}/history`);
        const data = await res.json();
        if (!res.ok) {
          histError.textContent = data.detail || "Error loading history";
          return;
        }
        if (!data.length) {
          histTableBody.innerHTML = `<tr><td colspan="5" class="muted">No past quizzes found. Generate one first.</td></tr>`;
          return;
        }

        histTableBody.innerHTML = data.map(item => `
          <tr>
            <td>${item.id}</td>
            <td>${escapeHtml(item.title)}</td>
            <td class="url" title="${escapeHtml(item.url)}">${escapeHtml(item.url)}</td>
            <td>${new Date(item.created_at).toLocaleString()}</td>
            <td><button class="small" onclick="openDetails(${item.id})">Details</button></td>
          </tr>
        `).join("");
      } catch (e) {
        histError.textContent = "Backend not reachable.";
      }
    }

    btnRefresh.onclick = loadHistory;

    window.openDetails = async function(id) {
      modalContent.innerHTML = "<p class='muted'>Loading...</p>";
      overlay.style.display = "flex";
      try {
        const res = await fetch(`${API}/quiz/${id}`);
        const data = await res.json();
        if (!res.ok) {
          modalContent.innerHTML = `<p class="error">${escapeHtml(data.detail || "Error")}</p>`;
          return;
        }
        renderQuiz(data, modalContent);
      } catch (e) {
        modalContent.innerHTML = "<p class='error'>Backend not reachable.</p>";
      }
    }
  </script>
</body>
</html>
